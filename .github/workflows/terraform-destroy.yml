name: Terraform Destroy (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment for GitHub environment protection'
        required: true
        type: string
      terraform-environment:
        description: 'Terraform environment (staging, prod)'
        required: true
        type: string
      terraform-working-directory:
        description: 'Working directory for Terraform'
        required: true
        type: string
      aws-environment:
        description: 'AWS environment'
        required: true
        type: string
      project:
        description: 'Project name'
        required: true
        type: string
      aws-role-name:
        description: 'AWS IAM role name for OIDC'
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      TF_BACKEND_BUCKET:
        required: false
      BUCKET_NAME_SUFFIX:
        required: false
      SUBNET_IDS:
        required: false

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0
  TF_VAR_aws_region: us-east-1

jobs:
  destroy:
    name: Destroy ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    # Use environment protection for destructive operations
    environment: 
      name: ${{ inputs.environment }}
    
    defaults:
      run:
        shell: bash
        working-directory: ${{ inputs.terraform-working-directory }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false
    
    - name: Terraform Init
      id: init
      run: |
        # Initialize with backend configuration from secrets if provided
        if [ -n "${{ secrets.TF_BACKEND_BUCKET }}" ]; then
          echo "Using S3 backend: ${{ secrets.TF_BACKEND_BUCKET }}"
          # Convert sagemaker-studio/terraform/staging to sagemaker-studio/staging
          state_key=$(echo "${{ inputs.terraform-working-directory }}" | sed 's|/terraform||')
          echo "State key: ${state_key}/terraform.tfstate"
          echo "Region: ${{ env.AWS_REGION }}"
          
          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="key=${state_key}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"
        else
          echo "WARNING: Using local backend (not recommended for production)"
          terraform init -migrate-state -input=false || terraform init
        fi
    
    - name: Set Variables
      id: vars
      run: |
        # Set common variables
        export TF_VAR_bucket_name_suffix="${{ secrets.BUCKET_NAME_SUFFIX || 'zali-staging' }}"
        export TF_VAR_github_repository="${{ github.repository }}"
        export TF_VAR_github_workflow="${{ github.workflow }}"
        
        # Set hardcoded variables for staging
        export TF_VAR_vpc_id="vpc-0a9ee577"
        
        # Set subnet IDs (optional - will auto-discover from VPC if not provided)
        if [ -n "${{ secrets.SUBNET_IDS }}" ]; then
          export TF_VAR_subnet_ids='[${{ secrets.SUBNET_IDS }}]'
          echo "Using provided subnet IDs from secret"
        else
          echo "Subnet IDs not provided - will auto-discover from VPC"
        fi
        
        # Save variables to environment file for next step
        echo "TF_VAR_bucket_name_suffix=${TF_VAR_bucket_name_suffix}" >> $GITHUB_ENV
        echo "TF_VAR_github_repository=${TF_VAR_github_repository}" >> $GITHUB_ENV
        echo "TF_VAR_github_workflow=${TF_VAR_github_workflow}" >> $GITHUB_ENV
        echo "TF_VAR_vpc_id=${TF_VAR_vpc_id}" >> $GITHUB_ENV
        
        if [ -n "${TF_VAR_subnet_ids:-}" ]; then
          echo "TF_VAR_subnet_ids=${TF_VAR_subnet_ids}" >> $GITHUB_ENV
        fi
    
    - name: Pre-destroy Check
      run: |
        echo "Starting ${{ inputs.environment }} DESTROY operation..."
        echo "WARNING: This will permanently delete all resources!"
        echo "Configuration:"
        echo "  - Environment: ${{ inputs.environment }}"
        echo "  - Project: ${{ inputs.project }}"
        echo "  - Region: ${{ env.AWS_REGION }}"
        echo "  - VPC ID: configured"
        echo "  - Subnet IDs: configured"
        echo ""
        echo "Destroy operation may take 5-20 minutes depending on service..."
    
    - name: Terraform Plan Destroy
      id: plan
      run: |
        echo "Planning ${{ inputs.environment }} destruction..."
        terraform plan -destroy -no-color -input=false -out=tfdestroy
    
    - name: Upload Destroy Plan Artifact
      if: steps.plan.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: tfdestroy-${{ inputs.environment }}
        path: ${{ inputs.terraform-working-directory }}/tfdestroy
        retention-days: 1
    
    - name: Terraform Destroy
      id: destroy
      run: |
        echo "Destroying ${{ inputs.environment }} infrastructure..."
        echo "WARNING: This operation cannot be undone!"
        
        # Apply the destroy plan
        terraform apply -auto-approve tfdestroy
    
    - name: Destruction Summary
      if: steps.destroy.outcome == 'success'
      run: |
        echo "## ${{ inputs.environment }} Infrastructure Destroyed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Destruction Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Project**: \`${{ inputs.project }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: \`${{ env.AWS_REGION }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Important Notes" >> $GITHUB_STEP_SUMMARY
        echo "- All resources have been permanently deleted" >> $GITHUB_STEP_SUMMARY
        echo "- Terraform state has been updated to reflect the destruction" >> $GITHUB_STEP_SUMMARY
        echo "- Data stored in deleted resources is not recoverable" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [AWS Console](https://console.aws.amazon.com/)" >> $GITHUB_STEP_SUMMARY
    
    - name: Cleanup on Failure
      if: failure()
      run: |
        echo "ERROR: Destroy operation failed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Troubleshooting" >> $GITHUB_STEP_SUMMARY
        echo "- Check the logs above for specific error messages" >> $GITHUB_STEP_SUMMARY
        echo "- Some resources may have dependencies that prevent deletion" >> $GITHUB_STEP_SUMMARY
        echo "- Manual cleanup may be required via AWS Console" >> $GITHUB_STEP_SUMMARY
        echo "- Terraform state may be inconsistent - review carefully" >> $GITHUB_STEP_SUMMARY
