name: Deploy SageMaker Studio (Staging)

on:
  push:
    branches:
      - main
    paths:
      - 'sagemaker-studio/terraform/staging/**'
      - 'terraform/module/sagemaker-studio/**'
      - '.github/workflows/sagemaker-studio-deploy.yml'
  
  pull_request:
    branches:
      - main
    paths:
      - 'sagemaker-studio/terraform/staging/**'
      - 'terraform/module/sagemaker-studio/**'
      - '.github/workflows/sagemaker-studio-deploy.yml'
  
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0
  TF_VAR_aws_region: us-east-1

jobs:
  terraform:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    
    # Use environment protection for production-like deployments
    environment: 
      name: staging
      url: ${{ steps.outputs.outputs.sagemaker_domain_url }}
    
    defaults:
      run:
        shell: bash
        working-directory: ./sagemaker-studio/terraform/staging
    
    permissions:
      contents: read
      pull-requests: write
      id-token: write  # Required for OIDC authentication
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false
    
    - name: Terraform Format Check
      id: fmt
      run: terraform fmt -check -recursive
      continue-on-error: true
    
    - name: Terraform Init
      id: init
      run: |
        # Initialize with backend configuration from secrets if provided
        if [ -n "${{ secrets.TF_BACKEND_BUCKET }}" ]; then
          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="key=sagemaker-studio/staging/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"
        else
          terraform init
        fi
    
    - name: Terraform Validate
      id: validate
      run: terraform validate -no-color
    
    - name: Terraform Plan
      id: plan
      run: |
        # Set additional variables from secrets
        export TF_VAR_vpc_id="${{ secrets.VPC_ID }}"
        export TF_VAR_bucket_name_suffix="${{ secrets.BUCKET_NAME_SUFFIX || 'zali-staging' }}"
        
        # Set subnet IDs if provided (comma-separated list)
        if [ -n "${{ secrets.SUBNET_IDS }}" ]; then
          export TF_VAR_subnet_ids='[${{ secrets.SUBNET_IDS }}]'
        fi
        
        # Validate that required variables are set
        if [ -z "$TF_VAR_vpc_id" ]; then
          echo "ERROR: VPC_ID secret is not set or empty"
          exit 1
        fi
        
        # Validate VPC ID format (without exposing the actual value)
        if [[ ! "$TF_VAR_vpc_id" =~ ^vpc-[a-z0-9]{8,17}$ ]]; then
          echo "ERROR: VPC_ID format is invalid. Expected format: vpc-xxxxxxxxx"
          exit 1
        fi
        
        echo "âœ“ VPC ID secret is configured and format is valid"
        echo "âœ“ Region: $TF_VAR_aws_region"
        
        # Test AWS connectivity and VPC existence
        echo "ğŸ” Testing AWS connectivity..."
        aws sts get-caller-identity
        
        echo "ğŸ” Checking if VPC exists in region $TF_VAR_aws_region..."
        if aws ec2 describe-vpcs --vpc-ids "$TF_VAR_vpc_id" --region "$TF_VAR_aws_region" >/dev/null 2>&1; then
          echo "âœ… VPC found in region $TF_VAR_aws_region"
          
          # Get VPC details
          echo "ğŸ“‹ VPC Details:"
          aws ec2 describe-vpcs --vpc-ids "$TF_VAR_vpc_id" --region "$TF_VAR_aws_region" \
            --query 'Vpcs[0].[VpcId,State,CidrBlock,IsDefault]' --output table
          
          # Check subnets in VPC
          echo "ğŸ“‹ Subnets in VPC:"
          subnet_count=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$TF_VAR_vpc_id" --region "$TF_VAR_aws_region" \
            --query 'length(Subnets)' --output text)
          
          if [ "$subnet_count" -eq 0 ]; then
            echo "âŒ No subnets found in VPC $TF_VAR_vpc_id"
            echo "ğŸ”§ SageMaker Studio requires at least one subnet. Please create subnets in your VPC."
            exit 1
          else
            echo "âœ… Found $subnet_count subnet(s) in VPC"
            aws ec2 describe-subnets --filters "Name=vpc-id,Values=$TF_VAR_vpc_id" --region "$TF_VAR_aws_region" \
              --query 'Subnets[*].[SubnetId,AvailabilityZone,CidrBlock,State,MapPublicIpOnLaunch]' --output table
          fi
          
          # Validate specific subnet IDs if provided
          if [ -n "$TF_VAR_subnet_ids" ]; then
            echo "ğŸ” Validating provided subnet IDs..."
            
            # Parse subnet IDs from the Terraform format [\"subnet-xxx\",\"subnet-yyy\"]
            # Remove brackets and quotes, then split by comma
            provided_subnets=$(echo "$TF_VAR_subnet_ids" | sed 's/\[//g; s/\]//g; s/"//g' | tr ',' ' ')
            
            echo "ğŸ“‹ Checking provided subnets: $provided_subnets"
            
            for subnet_id in $provided_subnets; do
              subnet_id=$(echo "$subnet_id" | xargs) # trim whitespace
              if [ -n "$subnet_id" ]; then
                echo "ğŸ” Checking subnet: $subnet_id"
                if aws ec2 describe-subnets --subnet-ids "$subnet_id" --region "$TF_VAR_aws_region" >/dev/null 2>&1; then
                  # Check if subnet belongs to the VPC
                  subnet_vpc=$(aws ec2 describe-subnets --subnet-ids "$subnet_id" --region "$TF_VAR_aws_region" \
                    --query 'Subnets[0].VpcId' --output text)
                  if [ "$subnet_vpc" = "$TF_VAR_vpc_id" ]; then
                    echo "âœ… Subnet $subnet_id is valid and belongs to VPC $TF_VAR_vpc_id"
                  else
                    echo "âŒ Subnet $subnet_id belongs to VPC $subnet_vpc, not $TF_VAR_vpc_id"
                    exit 1
                  fi
                else
                  echo "âŒ Subnet $subnet_id not found in region $TF_VAR_aws_region"
                  exit 1
                fi
              fi
            done
            echo "âœ… All provided subnet IDs are valid"
          else
            echo "â„¹ï¸ No specific subnet IDs provided - will use all available subnets in VPC"
          fi
        else
          echo "âŒ VPC not found in region $TF_VAR_aws_region"
          echo "ğŸ” Error details:"
          aws ec2 describe-vpcs --vpc-ids "$TF_VAR_vpc_id" --region "$TF_VAR_aws_region" 2>&1 || true
          
          echo "ğŸ” Checking other common regions..."
          for region in us-east-1 us-west-1 us-west-2 eu-west-1 ap-southeast-1; do
            if [ "$region" != "$TF_VAR_aws_region" ]; then
              if aws ec2 describe-vpcs --vpc-ids "$TF_VAR_vpc_id" --region "$region" >/dev/null 2>&1; then
                echo "ğŸ” VPC found in region: $region"
              fi
            fi
          done
          echo "âŒ Please check your VPC ID and region configuration"
          exit 1
        fi
        
        terraform plan -no-color -input=false -out=tfplan
      env:
        TF_VAR_github_repository: ${{ github.repository }}
        TF_VAR_github_workflow: ${{ github.workflow }}
    
    - name: Add Plan to PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('Terraform Plan Results')
          );
          
          const output = `## Terraform Plan Results ğŸš€
          
          #### Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`
          #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
          #### Terraform Validation ğŸ¤–\`${{ steps.validate.outcome }}\`
          #### Terraform Plan ğŸ“–\`${{ steps.plan.outcome }}\`
          
          <details><summary>Show Plan</summary>
          
          \`\`\`terraform
          ${{ steps.plan.outputs.stdout }}
          \`\`\`
          
          </details>
          
          *Workflow: \`${{ github.workflow }}\`, Action: \`plan\`, Working Directory: \`sagemaker-studio/terraform/staging\`, Workflow: \`${{ github.event_name }}\`*`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: output
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            });
          }
    
    - name: Terraform Apply
      id: apply
      if: |
        (github.ref == 'refs/heads/main' && github.event_name == 'push') || 
        (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
      run: |
         export TF_VAR_vpc_id="${{ secrets.VPC_ID }}"
         export TF_VAR_bucket_name_suffix="${{ secrets.BUCKET_NAME_SUFFIX || 'zali-staging' }}"
         
         # Set subnet IDs if provided (comma-separated list)
         if [ -n "${{ secrets.SUBNET_IDS }}" ]; then
           export TF_VAR_subnet_ids='[${{ secrets.SUBNET_IDS }}]'
         fi
         
         # Validate that required variables are set  
         if [ -z "$TF_VAR_vpc_id" ]; then
           echo "ERROR: VPC_ID secret is not set or empty"
           exit 1
         fi
         
         echo "VPC ID secret is configured"
         
         terraform apply -auto-approve tfplan
      env:
        TF_VAR_github_repository: ${{ github.repository }}
        TF_VAR_github_workflow: ${{ github.workflow }}
    
    - name: Terraform Destroy
      id: destroy
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
      run: |
         export TF_VAR_vpc_id="${{ secrets.VPC_ID }}"
         export TF_VAR_bucket_name_suffix="${{ secrets.BUCKET_NAME_SUFFIX || 'zali-staging' }}"
         
         # Set subnet IDs if provided (comma-separated list)
         if [ -n "${{ secrets.SUBNET_IDS }}" ]; then
           export TF_VAR_subnet_ids='[${{ secrets.SUBNET_IDS }}]'
         fi
         
         # Validate that required variables are set  
         if [ -z "$TF_VAR_vpc_id" ]; then
           echo "ERROR: VPC_ID secret is not set or empty"
           exit 1
         fi
         
         echo "VPC ID secret is configured"
         
         terraform destroy -auto-approve
      env:
        TF_VAR_github_repository: ${{ github.repository }}
        TF_VAR_github_workflow: ${{ github.workflow }}
    
    - name: Get Terraform Outputs
      id: outputs
      if: steps.apply.outcome == 'success'
      run: |
        echo "sagemaker_domain_url=$(terraform output -raw sagemaker_domain_url)" >> $GITHUB_OUTPUT
        echo "sagemaker_domain_id=$(terraform output -raw sagemaker_domain_id)" >> $GITHUB_OUTPUT
        echo "ml_artifacts_bucket_name=$(terraform output -raw ml_artifacts_bucket_name)" >> $GITHUB_OUTPUT
    
    - name: Summary
      if: steps.apply.outcome == 'success'
      run: |
        echo "## ğŸš€ SageMaker Studio Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain ID**: \`${{ steps.outputs.outputs.sagemaker_domain_id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain URL**: ${{ steps.outputs.outputs.sagemaker_domain_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ML Artifacts Bucket**: \`${{ steps.outputs.outputs.ml_artifacts_bucket_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **User Profile**: \`zali\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: \`staging\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [SageMaker Studio Console](${{ steps.outputs.outputs.sagemaker_domain_url }})" >> $GITHUB_STEP_SUMMARY
        echo "- [AWS Console](https://console.aws.amazon.com/sagemaker/home?region=${{ env.AWS_REGION }}#/studio)" >> $GITHUB_STEP_SUMMARY
