name: Deploy SageMaker Studio (Staging)

on:
  push:
    branches:
      - main
    paths:
      - 'sagemaker-studio/terraform/staging/**'
      - 'terraform/module/sagemaker-studio/**'
      - '.github/workflows/sagemaker-studio-deploy.yml'
  
  pull_request:
    branches:
      - main
    paths:
      - 'sagemaker-studio/terraform/staging/**'
      - 'terraform/module/sagemaker-studio/**'
      - '.github/workflows/sagemaker-studio-deploy.yml'
  
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0
  TF_VAR_aws_region: us-east-1

jobs:
  terraform:
    name: Terraform Deploy
    runs-on: ubuntu-latest
    
    # Use environment protection for production-like deployments
    environment: 
      name: staging
      url: ${{ steps.outputs.outputs.sagemaker_domain_url }}
    
    defaults:
      run:
        shell: bash
        working-directory: ./sagemaker-studio/terraform/staging
    
    permissions:
      contents: read
      pull-requests: write
      id-token: write  # Required for OIDC authentication
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false
    
    - name: Terraform Format Check
      id: fmt
      run: terraform fmt -check -recursive
      continue-on-error: true
    
    - name: Terraform Init
      id: init
      run: |
        # Initialize with backend configuration from secrets if provided
        if [ -n "${{ secrets.TF_BACKEND_BUCKET }}" ]; then
          echo "ğŸ—„ï¸ Using S3 backend: ${{ secrets.TF_BACKEND_BUCKET }}"
          terraform init \
            -backend-config="bucket=${{ secrets.TF_BACKEND_BUCKET }}" \
            -backend-config="key=sagemaker-studio/staging/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"
        else
          echo "âš ï¸ Using local backend (not recommended for production)"
          echo "ğŸ’¡ Set TF_BACKEND_BUCKET secret for remote state management"
          # Use local backend by migrating from S3 backend config
          terraform init -migrate-state -input=false || terraform init
        fi
    
    - name: Terraform Validate
      id: validate
      run: terraform validate -no-color
    
    - name: Terraform Plan
      id: plan
      run: |
        # Set additional variables from secrets
        # VPC ID is now hardcoded in the module, no need for VPC_ID secret
        export TF_VAR_bucket_name_suffix="${{ secrets.BUCKET_NAME_SUFFIX || 'zali-staging' }}"
        
        # Set subnet IDs (now required)
        if [ -n "${{ secrets.SUBNET_IDS }}" ]; then
          export TF_VAR_subnet_ids='[${{ secrets.SUBNET_IDS }}]'
        else
          echo "ERROR: SUBNET_IDS secret is required but not set"
          echo "Please set SUBNET_IDS secret with comma-separated subnet IDs: \"subnet-xxx\",\"subnet-yyy\""
          exit 1
        fi
        
        echo "â„¹ï¸  Using hardcoded VPC ID: vpc-0a9ee577"
        
        terraform plan -no-color -input=false -out=tfplan
      env:
        TF_VAR_github_repository: ${{ github.repository }}
        TF_VAR_github_workflow: ${{ github.workflow }}
    
    - name: Plan Summary
      if: steps.plan.outcome == 'success'
      run: |
        echo "## ğŸ“‹ Plan Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Terraform plan completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "ğŸ“ **Pull Request**: Plan results shown above for review" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ **Proceeding with deployment** (PR environment)" >> $GITHUB_STEP_SUMMARY
        elif [[ "${{ github.event.inputs.action }}" == "plan" ]] || [[ "${{ github.event_name }}" == "push" ]]; then
          echo "ğŸš€ **Proceeding with automatic deployment...**" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ Plan completed. Apply step will run based on workflow conditions." >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Add Plan to PR Comment
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('Terraform Plan Results')
          );
          
          const output = `## Terraform Plan Results ğŸš€
          
          #### Terraform Format and Style ğŸ–Œ\`${{ steps.fmt.outcome }}\`
          #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
          #### Terraform Validation ğŸ¤–\`${{ steps.validate.outcome }}\`
          #### Terraform Plan ğŸ“–\`${{ steps.plan.outcome }}\`
          
          <details><summary>Show Plan</summary>
          
          \`\`\`terraform
          ${{ steps.plan.outputs.stdout }}
          \`\`\`
          
          </details>
          
          *Workflow: \`${{ github.workflow }}\`, Action: \`plan\`, Working Directory: \`sagemaker-studio/terraform/staging\`, Workflow: \`${{ github.event_name }}\`*`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: output
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            });
          }
    
    - name: Pre-Apply Check
      if: |
        steps.plan.outcome == 'success' && (
          github.event_name == 'pull_request' ||
          (github.ref == 'refs/heads/main' && github.event_name == 'push') || 
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
        )
      run: |
        echo "ğŸš€ Starting SageMaker Studio deployment..."
        echo "ğŸ“Š Configuration:"
        echo "  - VPC ID: configured âœ“"
        echo "  - Subnet IDs: configured âœ“" 
        echo "  - User: zali"
        echo "  - Environment: staging"
        echo "  - Region: ${{ env.AWS_REGION }}"
        echo ""
        echo "â³ This may take 15-20 minutes..."
    
    - name: Terraform Apply
      id: apply
      if: |
        steps.plan.outcome == 'success' && (
          github.event_name == 'pull_request' ||
          (github.ref == 'refs/heads/main' && github.event_name == 'push') || 
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply') ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'plan')
        )
      run: |
                   # VPC ID is now hardcoded in the module
         export TF_VAR_bucket_name_suffix="${{ secrets.BUCKET_NAME_SUFFIX || 'zali-staging' }}"
         
          # Set subnet IDs (now required)
          if [ -n "${{ secrets.SUBNET_IDS }}" ]; then
            export TF_VAR_subnet_ids='[${{ secrets.SUBNET_IDS }}]'
          else
            echo "ERROR: SUBNET_IDS secret is required but not set"
            exit 1
          fi
         
         # Validate that required variables are set  
         if [ -z "$TF_VAR_vpc_id" ]; then
           echo "ERROR: VPC_ID secret is not set or empty"
           exit 1
         fi
         
         echo "VPC ID secret is configured"
         
         terraform apply -auto-approve tfplan
      env:
        TF_VAR_github_repository: ${{ github.repository }}
        TF_VAR_github_workflow: ${{ github.workflow }}
    
    - name: Terraform Destroy
      id: destroy
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
      run: |
                   # VPC ID is now hardcoded in the module
         export TF_VAR_bucket_name_suffix="${{ secrets.BUCKET_NAME_SUFFIX || 'zali-staging' }}"
         
          # Set subnet IDs (now required)
          if [ -n "${{ secrets.SUBNET_IDS }}" ]; then
            export TF_VAR_subnet_ids='[${{ secrets.SUBNET_IDS }}]'
          else
            echo "ERROR: SUBNET_IDS secret is required but not set"
            exit 1
          fi
         
         # Validate that required variables are set  
         if [ -z "$TF_VAR_vpc_id" ]; then
           echo "ERROR: VPC_ID secret is not set or empty"
           exit 1
         fi
         
         echo "VPC ID secret is configured"
         
         terraform destroy -auto-approve
      env:
        TF_VAR_github_repository: ${{ github.repository }}
        TF_VAR_github_workflow: ${{ github.workflow }}
    
    - name: Get Terraform Outputs
      id: outputs
      if: steps.apply.outcome == 'success'
      run: |
        echo "sagemaker_domain_url=$(terraform output -raw sagemaker_domain_url)" >> $GITHUB_OUTPUT
        echo "sagemaker_domain_id=$(terraform output -raw sagemaker_domain_id)" >> $GITHUB_OUTPUT
        echo "ml_artifacts_bucket_name=$(terraform output -raw ml_artifacts_bucket_name)" >> $GITHUB_OUTPUT
    
    - name: Summary
      if: steps.apply.outcome == 'success'
      run: |
        echo "## ğŸš€ SageMaker Studio Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain ID**: \`${{ steps.outputs.outputs.sagemaker_domain_id }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain URL**: ${{ steps.outputs.outputs.sagemaker_domain_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ML Artifacts Bucket**: \`${{ steps.outputs.outputs.ml_artifacts_bucket_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **User Profile**: \`zali\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: \`staging\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [SageMaker Studio Console](${{ steps.outputs.outputs.sagemaker_domain_url }})" >> $GITHUB_STEP_SUMMARY
        echo "- [AWS Console](https://console.aws.amazon.com/sagemaker/home?region=${{ env.AWS_REGION }}#/studio)" >> $GITHUB_STEP_SUMMARY
